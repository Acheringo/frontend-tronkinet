<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Perfil - Mini Twitter</title>
    <style>
        /* Estilo para que la imagen de perfil siempre sea un círculo perfecto */
        .avatar-frame {
            width: 120px;
            height: 120px;
            position: relative;
            overflow: hidden;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3b82f6; /* Azul por defecto */
        }
        .avatar-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-100">

    <nav class="bg-white shadow mb-6">
        <div class="max-w-2xl mx-auto flex justify-around p-4 font-bold">
            <a href="index.html" class="font-bold text-gray-600">Global</a>
            <a href="seguidos.html" class="font-bold text-gray-600">Siguiendo</a>
            <a href="perfil.html" class="font-bold text-blue-500">Tú (<b id="display-username" class="font-bold text-blue-500"></b>)</a>
            <button onclick="logout()" class="text-red-500">Salir</button>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto px-4">
        <div class="bg-white rounded-xl shadow-md p-8 mb-8 text-center">
            
            <div class="flex justify-center mb-4">
                <div id="avatar-clickable" class="relative group">
                    <div class="avatar-frame shadow-lg border-4 border-white">
                        <span id="avatar-letra" class="text-white text-5xl">?</span>
                        <img id="avatar-img" src="" class="hidden">
                    </div>
                    
                    <div id="edit-overlay" onclick="document.getElementById('inputFoto').click()" 
                         class="absolute inset-0 bg-black bg-opacity-40 rounded-full flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition cursor-pointer hidden">
                        Cambiar foto
                    </div>
                </div>
            </div>

            <input type="file" id="inputFoto" class="hidden" accept="image/*" onchange="subirFoto()">

            <h1 id="profile-name" class="text-2xl font-bold text-gray-800">Cargando...</h1>
            
            <div class="flex justify-around mt-8 border-t pt-6">
                <div><span id="count-posts" class="block font-bold text-xl">0</span><span class="text-gray-400 text-xs uppercase">Posts</span></div>
                <div><span id="count-followers" class="block font-bold text-xl">0</span><span class="text-gray-400 text-xs uppercase">Seguidores</span></div>
                <div><span id="count-following" class="block font-bold text-xl">0</span><span class="text-gray-400 text-xs uppercase">Siguiendo</span></div>
            </div>
        </div>

        <h2 id="titulo-posts" class="text-xl font-bold mb-4 text-gray-700">Publicaciones</h2>
        <div id="mis-posts" class="space-y-4 pb-10"></div>
    </div>

    <script>
        const API_URL = "https://collins-otherwise-investigate-tony.trycloudflare.com";
        const urlParams = new URLSearchParams(window.location.search);
        const userIdEnURL = urlParams.get('id');
        const miId = localStorage.getItem('userId');
        const idAMostrar = userIdEnURL ? userIdEnURL : miId;
        const esMiPropioPerfil = !userIdEnURL || userIdEnURL === miId;

        async function cargarDatosPerfil() {
            try {
                const res = await fetch(`${API_URL}/perfil/${idAMostrar}`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                const data = await res.json();

                document.getElementById('profile-name').innerText = "@" + data.username;
                document.getElementById('count-posts').innerText = data.total_posts;
                document.getElementById('count-followers').innerText = data.seguidores;
                document.getElementById('count-following').innerText = data.seguidos;

                // Lógica de Foto de Perfil
                const avatarLetra = document.getElementById('avatar-letra');
                const avatarImg = document.getElementById('avatar-img');
                
                if (data.foto_perfil) {
                    // Importante: La URL debe apuntar al servidor FastAPI
                    avatarImg.src = `${API_URL}/${data.foto_perfil}`;
                    avatarImg.classList.remove('hidden');
                    avatarLetra.classList.add('hidden');
                } else {
                    avatarLetra.innerText = data.username[0].toUpperCase();
                    avatarImg.classList.add('hidden');
                    avatarLetra.classList.remove('hidden');
                }

                // Si es mi perfil, mostrar opción de editar
                if (esMiPropioPerfil) {
                    document.getElementById('edit-overlay').classList.remove('hidden');
                    document.getElementById('titulo-posts').innerText = "Mis Publicaciones";
                }

                const feed = document.getElementById('mis-posts');
                feed.innerHTML = '';
                data.posts.forEach(post => {
                    const botonEliminar = esMiPropioPerfil 
                        ? `<button onclick="borrarPost(${post.id})" class="text-red-500 hover:text-red-700 font-bold">Eliminar</button>` 
                        : "";

                    feed.innerHTML += `
                        <div id="post-${post.id}" class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                            <p class="text-gray-800">${post.content}</p>
                            <div class="flex justify-between items-center mt-3 text-xs text-gray-400">
                                <div class="flex space-x-4">
                                    <span>${post.create_time}</span>
                                    <span class="text-red-400 font-bold">❤️ ${post.total_likes}</span>
                                </div>
                                ${botonEliminar}
                            </div>
                        </div>`;
                });

            } catch (err) { console.error(err); }
        }

        async function subirFoto() {
            const input = document.getElementById('inputFoto');
            if (input.files.length === 0) return;

            // En C++ esto sería como empaquetar un struct binario para el socket
            const formData = new FormData();
            formData.append("file", input.files[0]);

            try {
                const res = await fetch(`${API_URL}/upload-foto/${miId}`, {
                    method: "POST",
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: formData
                });
                
                if (res.ok) {
                    alert("¡Foto actualizada!");
                    cargarDatosPerfil(); // Recargamos la info
                }
            } catch (err) { alert("Error al subir la imagen"); }
        }
        const nombreUsuario = localStorage.getItem('username');
        document.getElementById('display-username').innerText = nombreUsuario;
        async function borrarPost(postId) {
            if (!confirm("¿Estás seguro de que quieres borrar este post?")) return;

            try {
                const res = await fetch(`${API_URL}/posts/${postId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders() // Reutilizamos los headers con el Token JWT
                });

                if (res.ok) {
                    // Eliminación visual inmediata (Robustez: no necesitamos recargar toda la página)
                    document.getElementById(`post-${postId}`).remove();
                    
                    // Opcional: Recargar contadores de perfil
                    cargarDatosPerfil(); 
                } else {
                    const err = await res.json();
                    alert("Error: " + err.detail);
                }
            } catch (error) {
                console.error("Error al borrar:", error);
            }
        }

        function logout() { localStorage.clear(); window.location.href = "login.html"; }
        window.onload = cargarDatosPerfil;
    </script>
</body>
</html>