<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TRONKINET</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<style>
    .ml-13 { margin-left: 3.25rem; } /* Alinea el texto con el nombre, saltándose el avatar */
</style>
<body class="bg-gray-100 font-sans">
    <div id="auth-seccion" class="bg-white p-6 rounded-lg shadow-md mb-8 border-t-4 border-blue-500">

    <nav class="bg-white shadow mb-6">
    <div class="max-w-2xl mx-auto flex justify-around p-4">
        <a href="index.html" class="font-bold text-blue-500">Global</a>
        <a href="seguidos.html" class="font-bold text-gray-600">Siguiendo</a>
        <a href="perfil.html" class="font-bold text-gray-600">Tú (<b id="display-username" class="font-bold text-gray-600"></b>)</a>
        <button onclick="logout()" class="text-red-500">Salir</button>
    </div>
    </nav>

    <div class="max-w-2xl mx-auto mb-6">
        <div class="relative">
            <input type="text" id="inputBusqueda" onkeyup="ejecutarBusqueda()" 
                placeholder="Buscar amigos por nombre..." 
                class="w-full p-3 rounded-lg border shadow-sm focus:ring-2 focus:ring-blue-400 outline-none">
            
            <div id="resultadosBusqueda" class="absolute w-full bg-white shadow-xl rounded-b-lg z-10 hidden border-x border-b">
                </div>
        </div>
    </div>

    <div class="max-w-2xl mx-auto py-10">
        <h1 class="text-3xl font-bold mb-6 text-blue-500 text-center">TRONKINET</h1>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <textarea id="postContent" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="¿Qué está pasando?"></textarea>
            <div class="flex justify-end mt-3">
                <button onclick="enviarPost()" class="bg-blue-500 text-white px-6 py-2 rounded-full font-bold hover:bg-blue-600 transition">
                    Postear
                </button>
            </div>
        </div>

        <div id="feed" class="space-y-4">
            </div>
    </div>

    <script>
        const API_URL = "https://collins-otherwise-investigate-tony.trycloudflare.com";
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'ngrok-skip-browser-warning': 'true'
            };
        }
        async function cargarPosts() {
            const myId = Number(localStorage.getItem('userId'));
            
            // Enviamos nuestro ID como parámetro en la URL
            const respuesta = await fetch(`${API_URL}/posts?current_user_id=${myId}`,
                { headers: getAuthHeaders() }
            );
            const resultado = await respuesta.json();
            const feed = document.getElementById('feed');
            
            feed.innerHTML = ''; 

            resultado.data.forEach(post => {
                const autorId = Number(post.user_id);
                let botonSeguir = "";
                let avatarHTML="";
                if (post.foto_perfil) {
                    avatarHTML = `<img src="${API_URL}/${post.foto_perfil}" class="w-10 h-10 rounded-full object-cover">`;
                } else {
                    const inicial = post.username[0].toUpperCase();
                    avatarHTML = `
                        <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                            ${inicial}
                        </div>`;
                }

                if (autorId === myId) {
                    botonSeguir = `<span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">Tú</span>`;
                } else {
                    // Si post.lo_sigo es > 0, significa que ya existe la relación en la DB
                    if (post.lo_sigo > 0) {
                        botonSeguir = `
                            <button onclick="seguirUsuario(${autorId})" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-300 transition font-bold">
                                Siguiendo
                            </button>`;
                    } else {
                        botonSeguir = `
                            <button onclick="seguirUsuario(${autorId})" class="text-xs bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 transition font-bold">
                                + Seguir
                            </button>`;
                    }
                }

                feed.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-3">
                                <a href="perfil.html?id=${autorId}">
                                    ${avatarHTML}
                                </a>
                                <a href="perfil.html?id=${autorId}" class="font-bold text-blue-600 text-lg hover:underline">
                                    @${post.username}
                                </a>
                            </div>
                            ${botonSeguir}
                        </div>
                        
                        <p class="text-gray-800 ml-13">${post.content}</p>
                        <div class="flex justify-between items-center ml-13 text-xs text-gray-400">
                             <span>${post.create_time}</span>
                            <button onclick="darLike(${post.id})" class="text-gray-500 hover:text-red-500 flex items-center">
                                ❤️ <span class="ml-1">${post.total_likes || 0}</span>
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        // Nueva función para ejecutar el Follow
        async function seguirUsuario(idAFollow) {
            
            const res = await fetch(`${API_URL}/follow`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    followed_id: idAFollow
                })
            });
            
            const data = await res.json();
            if(data.status === "followed") {
                alert("¡Ahora sigues a este usuario!");
            } else {
                alert("Has dejado de seguir a este usuario.");
            }
            cargarPosts(); // Recargamos para actualizar los botones
        }

        // 1. COMPROBAR SESIÓN AL CARGAR
        const usuarioId = localStorage.getItem('userId');
        const nombreUsuario = localStorage.getItem('username');

        if (!usuarioId) {
            window.location.href = "login.html"; // Si no hay ID, a loguearse
        }

        // Al cargar la página, ponemos el nombre en la interfaz
        window.onload = () => {
            document.getElementById('display-username').innerText = nombreUsuario;
            cargarPosts();
        };
        // Esta función se ejecuta cuando la página termina de cargar
        window.onload = () => {
            // Comprobamos que el elemento existe antes de escribir en él
            const displaySpan = document.getElementById('display-username');
            if (displaySpan) {
                displaySpan.innerText = nombreUsuario;
            }
            
            cargarPosts(); // Tu función que ya tenías para traer los tweets
        };

        function logout() {
            localStorage.clear(); // Borra el userId y username
            window.location.href = "login.html"; // Salta al login
        }


        async function enviarPost() {
            // 1. Verificar si el token existe
            const token = localStorage.getItem('token');
            if (!token) {
                alert("No hay sesión activa");
                window.location.href = "login.html";
                return;
            }

            const contenido = document.getElementById('postContent').value;

            const res = await fetch(`${API_URL}/posts`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    // IMPORTANTE: Asegúrate de que no haya espacios extra o caracteres raros
                    'Authorization': 'Bearer ' + token 
                },
                body: JSON.stringify({ content: contenido })
            });

            if (res.ok) {
                document.getElementById('postContent').value = '';
                cargarPosts();
            } else {
                const errorData = await res.json();
                console.error("Error del servidor:", errorData);
            }
        }

        // Función para dar/quitar like
        async function darLike(postId) {
            const token = localStorage.getItem('token');
            
            const res = await fetch(`${API_URL}/likes`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    post_id: postId
                })
            });
            if(res.ok){
                cargarPosts();
            }
            else if(res.status===401){
                alert("Tu sesión ha expirado. Por favor, inicia sesión de nuevo.");
                logout();
                return;
            }
        }

        async function ejecutarBusqueda() {
            const query = document.getElementById('inputBusqueda').value;
            const listaResultados = document.getElementById('resultadosBusqueda');
            const myId = Number(localStorage.getItem('userId'));

            if (query.length < 2) {
                listaResultados.classList.add('hidden');
                return;
            }

            const res = await fetch(`${API_URL}/buscar-usuarios?query=${query}&current_user_id=${myId}`);
            const resultado = await res.json();

            listaResultados.innerHTML = '';
            listaResultados.classList.remove('hidden');

            if (resultado.data.length === 0) {
                listaResultados.innerHTML = '<div class="p-3 text-gray-500">No se encontraron usuarios</div>';
            } else {
                resultado.data.forEach(user => {
                    const textoBoton = user.lo_sigo > 0 ? 'Siguiendo' : '+ Seguir';
                    const colorBoton = user.lo_sigo > 0 ? 'bg-gray-200' : 'bg-blue-500 text-white';
                    listaResultados.innerHTML += `
                    <div class="flex justify-between items-center p-3 border-b hover:bg-gray-50">
                        <a href="perfil.html?id=${user.id}" class="font-bold text-blue-600 hover:underline">
                            @${user.username}
                        </a>
                        <button onclick="seguirUsuario(${user.id})" class="text-xs px-3 py-1 rounded-full font-bold ${colorBoton}">
                            ${textoBoton}
                        </button>
                    </div>
                `;
                });
            }
        }

        // Para cerrar la búsqueda si haces clic fuera
        document.addEventListener('click', (e) => {
            if (!document.getElementById('inputBusqueda').contains(e.target)) {
                document.getElementById('resultadosBusqueda').classList.add('hidden');
            }
        });
    </script>
</body>
</html>